function formatCurrency(total) {
    var neg = false;
    if(total < 0) {
        neg = true;
        total = Math.abs(total);
    }
    return (neg ? "-$" : '$') + parseFloat(total, 10).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,").toString();
}

function clearCounts() {
  $('.food_item_count').each(function(){
    $(this).val("0");
  })
};

function updateTodayCounts(){
  $('.food_item_count').each(function(){
    var oldCount = parseInt ( $(this).val() );
    var id = $(this).attr('data-product_id');
    var newCount = parseInt( $('#today_count_' + id).html() );
    $('#today_count_' + id).html( oldCount + newCount );
  })
}

function showSuccessMessage(){
  $('#success-msg').slideDown().delay( 500 ).slideUp();
}

function submitWasteCount( submit_data ){
  $.ajax({
    url: '/waste_counts/new',
    type: 'post',
    data: submit_data,
    dataType: 'json',
    success: function() { 
      updateTodayCounts();
      clearCounts();
      showSuccessMessage();
    }
  });
};

var ready;
ready = function() {
  $(document).on('click', '.submit_food_item_count', function(event){
    event.stopImmediatePropagation();
    event.preventDefault();
    var id = $(this).attr('id');
    var count = parseInt ( $('#food_item_count_' + id).val() ) + 1;
    $('#food_item_count_' + id).val( count );
    var cost = $('#today_cost_' + id).val() + (parseFloat( $('#today_cost_' + id).attr('data-price') ) * count);
    $('#today_cost_' + id).html(formatCurrency(cost));
  });

  $('#submit').click( function() {
    var submit_data = { waste_counts:[] };
    $('.food_item_count').each(function() {
      var food_id = $(this).attr('data-product_id');
      var count = $(this).val();
      var user_id = $('.current_user').attr('id');
      if( count > 0 ) {
        submit_data.waste_counts.push(
        { "food_id": food_id, "count": count, "user_id": user_id }
      );
      }
    });
    if( submit_data.waste_counts.length > 0 ) {
      submitWasteCount( submit_data );
    }
  });

  $(document).on('click', '#clear_counts', clearCounts );
}

$(document).ready(ready);
$(document).on('page:load', ready);


